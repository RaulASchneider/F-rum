<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #messages {
            border: 1px solid #000;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
        }

        form {
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            padding: 10px;
        }
    </style>
</head>
<body>

<h2>Chat</h2>

<div id="messages"></div>

<form id="sendForm">
    <input id="text" placeholder="Digite..." required>
    <button type="submit">Enviar</button>
</form>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<script>
/* ---------------------- USER ---------------------- */
async function checkUser() {
    const { data } = await db.auth.getUser();
    if (!data.user) {
        window.location.href = "login.html";
        return;
    }
    return data.user;
}

/* ---------------------- RENDER ---------------------- */
const messagesDiv = document.getElementById("messages");

function renderMessage(msg) {
    const el = document.createElement("p");

    const username = msg.profiles?.username ?? "(desconhecido)";
    const content = msg.content;

    el.textContent = username + ": " + content;

    messagesDiv.appendChild(el);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}


/* Busca username de 1 usuário */
async function fetchUsernameAndRender(msg) {
    // usar maybeSingle() evita erro quando não há linha correspondente
    const { data, error } = await db
        .from("profiles")
        .select("username")
        .eq("id", msg.user_id)
        .maybeSingle();

    // garante valor padrão seguro
    const username = (!error && data && data.username) ? data.username : "(desconhecido)";

    msg.profiles = { username };
    renderMessage(msg);
}


/* ---------------------- LOAD MESSAGES ---------------------- */
async function loadMessages() {
    const { data, error } = await db
        .from("messages")
        .select("id, content, user_id, profiles(username)")
        .order("created_at");

    if (error) {
        console.error(error);
        return;
    }

    data.forEach(renderMessage);
}

/* ---------------------- SEND ---------------------- */
document.getElementById("sendForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const text = document.getElementById("text").value;
    const user = await checkUser();

    const { data, error } = await db
        .from("messages")
        .insert({
            user_id: user.id,
            content: text
        })
        .select();

    if (error) {
        console.error("Erro:", error);
        alert(error.message);
        return;
    }

    // Quando o user envia, já podemos puxar username direto
    fetchUsernameAndRender(data[0]);

    document.getElementById("text").value = "";
});

/* ---------------------- REALTIME ---------------------- */
db.channel("chat")
.on(
    "postgres_changes",
    { event: "INSERT", schema: "public", table: "messages" },
    (payload) => {
        console.log("Realtime recebido:", payload.new);
        fetchUsernameAndRender(payload.new);
    }
)
.subscribe();

/* ---------------------- START ---------------------- */
checkUser();
loadMessages();

</script>

</body>
</html>
