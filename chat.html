<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #messages { border: 1px solid #000; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 20px; }
        form { display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; background: #f5f5f5; }
        .own-message { background: #e3f2fd; margin-left: 20px; }
        .error { color: red; }
        .success { color: green; }
        .verified-badge {
            color: #1DA1F2;
            margin-left: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<h2>Chat</h2>

<div id="status"></div>
<div id="messages"></div>

<form id="sendForm">
    <input id="text" placeholder="Digite..." required>
    <button type="submit">Enviar</button>
</form>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<script>
let currentUser = null;
let currentUsername = null;
let currentUserVerified = false;
const messagesDiv = document.getElementById("messages");
const statusDiv = document.getElementById("status");

function showStatus(message, type = 'info') {
    statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
    console.log(message);
}

/* ---------------------- USER ---------------------- */
async function checkUser() {
    try {
        const { data, error } = await db.auth.getUser();
        if (error || !data.user) {
            showStatus('Usuário não autenticado. Redirecionando...', 'error');
            setTimeout(() => window.location.href = "login.html", 2000);
            return null;
        }
        currentUser = data.user;
        
        // Busca ou cria o perfil do usuário
        const profileResult = await getOrCreateUserProfile(currentUser);
        
        if (profileResult.error) {
            showStatus('Erro ao carregar perfil', 'error');
            return null;
        }
        
        currentUsername = profileResult.username;
        currentUserVerified = profileResult.verified;
        
        showStatus(`Usuário: ${currentUsername} ${currentUserVerified ? '✓' : ''}`, 'success');
        return { 
            user: currentUser, 
            username: currentUsername, 
            verified: currentUserVerified 
        };
        
    } catch (error) {
        showStatus('Erro ao verificar usuário', 'error');
        console.error(error);
        return null;
    }
}

/* ---------------------- GET OR CREATE PROFILE ---------------------- */
async function getOrCreateUserProfile(user) {
    try {
        // Tenta buscar o perfil existente
        const { data: existingProfile, error: fetchError } = await db
            .from('profiles')
            .select('username, verified')
            .eq('id', user.id)
            .single();

        // Se encontrou, retorna
        if (existingProfile && !fetchError) {
            return {
                username: existingProfile.username,
                verified: existingProfile.verified || false
            };
        }

        // Se não encontrou, cria um novo perfil
        console.log('Perfil não encontrado, criando novo...');
        const username = user.user_metadata?.username || 
                        user.user_metadata?.full_name || 
                        user.email?.split('@')[0] || 
                        'Usuario';
        
        const { data: newProfile, error: createError } = await db
            .from('profiles')
            .insert({
                id: user.id,
                username: username,
                verified: false
            })
            .select('username, verified')
            .single();

        if (createError) {
            console.error('Erro ao criar perfil:', createError);
            // Fallback: usa dados básicos
            return {
                username: username,
                verified: false,
                error: createError
            };
        }

        return {
            username: newProfile.username,
            verified: newProfile.verified || false
        };

    } catch (error) {
        console.error('Erro em getOrCreateUserProfile:', error);
        return {
            username: user.email?.split('@')[0] || 'Usuario',
            verified: false,
            error: error
        };
    }
}

/* ---------------------- RENDER ---------------------- */
function renderMessage(msg) {
    const el = document.createElement("div");
    el.className = "message";
    
    const isOwnMessage = currentUser && msg.user_id === currentUser.id;
    
    if (isOwnMessage) {
        el.classList.add("own-message");
    }
    
    const username = msg.username || msg.user_id || "(desconhecido)";
    const verified = msg.verified || false;
    const content = msg.content;

    const verifiedBadge = verified ? '<span class="verified-badge">✓</span>' : '';

    el.innerHTML = `<strong>${username}${verifiedBadge}:</strong> ${content}`;
    el.setAttribute('data-message-id', msg.id);
    el.setAttribute('data-user-id', msg.user_id);

    messagesDiv.appendChild(el);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* ---------------------- LOAD MESSAGES ---------------------- */
async function loadMessages() {
    try {
        showStatus('Carregando mensagens...');
        
        const { data, error } = await db
            .from("messages")
            .select(`
                id, 
                content, 
                user_id,
                created_at,
                profiles!inner(username, verified)
            `)
            .order("created_at", { ascending: true });

        if (error) {
            console.log("Erro com join:", error);
            await loadMessagesWithoutJoin();
            return;
        }

        messagesDiv.innerHTML = '';
        
        if (data.length === 0) {
            messagesDiv.innerHTML = '<div>Nenhuma mensagem ainda. Seja o primeiro a enviar!</div>';
            showStatus('Nenhuma mensagem encontrada', 'info');
            return;
        }

        showStatus(`Carregadas ${data.length} mensagens`, 'success');

        data.forEach(msg => {
            const messageWithData = {
                ...msg,
                username: msg.profiles?.username || msg.user_id,
                verified: msg.profiles?.verified || false
            };
            renderMessage(messageWithData);
        });

    } catch (err) {
        showStatus('Erro ao carregar mensagens', 'error');
        console.error(err);
    }
}

/* ---------------------- LOAD MESSAGES WITHOUT JOIN ---------------------- */
async function loadMessagesWithoutJoin() {
    try {
        const { data, error } = await db
            .from("messages")
            .select(`
                id, 
                content, 
                user_id,
                created_at
            `)
            .order("created_at", { ascending: true });

        if (error) {
            showStatus(`Erro ao carregar mensagens: ${error.message}`, 'error');
            return;
        }

        messagesDiv.innerHTML = '';
        
        if (data.length === 0) {
            messagesDiv.innerHTML = '<div>Nenhuma mensagem ainda. Seja o primeiro a enviar!</div>';
            return;
        }

        for (const msg of data) {
            await fetchUserProfileAndRender(msg);
        }
    } catch (err) {
        console.error('Erro no load sem join:', err);
    }
}

/* ---------------------- FETCH USER PROFILE FOR MESSAGE ---------------------- */
async function fetchUserProfileAndRender(msg) {
    try {
        const { data, error } = await db
            .from("profiles")
            .select("username, verified")
            .eq("id", msg.user_id)
            .single();

        if (error) {
            console.error("Erro ao buscar perfil:", error);
            msg.username = `Usuario_${msg.user_id.substring(0, 8)}`;
            msg.verified = false;
        } else {
            msg.username = data.username;
            msg.verified = data.verified || false;
        }
        
        renderMessage(msg);
    } catch (err) {
        console.error("Erro na busca de perfil:", err);
        msg.username = "(desconhecido)";
        msg.verified = false;
        renderMessage(msg);
    }
}

/* ---------------------- SEND MESSAGE ---------------------- */
document.getElementById("sendForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const textInput = document.getElementById("text");
    const text = textInput.value.trim();

    if (!text) {
        showStatus('Digite uma mensagem!', 'error');
        return;
    }

    try {
        if (!currentUser) {
            await checkUser();
            if (!currentUser) return;
        }

        showStatus('Enviando mensagem...');

        const { data, error } = await db
            .from("messages")
            .insert({
                user_id: currentUser.id,
                content: text
            })
            .select()
            .single();

        if (error) {
            showStatus(`Erro ao enviar: ${error.message}`, 'error');
            console.error('Detalhes do erro:', error);
            return;
        }

        // Adiciona dados do usuário antes de renderizar
        data.username = currentUsername;
        data.verified = currentUserVerified;
        renderMessage(data);
        
        textInput.value = "";
        showStatus('Mensagem enviada com sucesso!', 'success');

    } catch (error) {
        showStatus('Erro inesperado', 'error');
        console.error(error);
    }
});

/* ---------------------- REALTIME ---------------------- */
function setupRealtime() {
    try {
        db.channel("public:messages")
            .on(
                "postgres_changes",
                { 
                    event: "INSERT", 
                    schema: "public", 
                    table: "messages" 
                },
                async (payload) => {
                    console.log("Nova mensagem em tempo real:", payload);
                    await fetchUserProfileAndRender(payload.new);
                }
            )
            .subscribe();
            
        showStatus('Conexão realtime ativa', 'success');
    } catch (error) {
        showStatus('Erro no realtime', 'error');
        console.error(error);
    }
}

/* ---------------------- INITIALIZE APP ---------------------- */
async function initializeApp() {
    try {
        const userInfo = await checkUser();
        if (userInfo) {
            await loadMessages();
            setupRealtime();
        }
    } catch (error) {
        console.error('Erro na inicialização:', error);
    }
}

// Inicializa o app
document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>